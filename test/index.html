<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>Randomizer Tests</title>
	<link href="test.css" media='screen' rel="stylesheet" TYPE="text/css">
</head>
<body>
	<div class="header">
		<h2>Randomizer Tests</h2>
		<img class="random" src="random_org.png" />
		<div style="clear:both"></div>
	</div>
	<table class="main">
		<tr>
			<td style='width: 200px'></td>
			<th>Math.random()</th>
			<th>Mersenne Twister</th>
			<th>Multiply With Carry</th>
			<th>Combined Multiple Recursive</th>
		</tr>
		<tr>
			<td style='width: 200px'></td>
			<td style="text-align:center">Javascript standard</td>
			<td style="text-align:center">By Matsumoto &amp; Nishimura (and <a href="https://gist.github.com/300494">Sean McCullough</a>)</td>
			<td style="text-align:center">Implementation is <a href="http://baagoe.com/en/RandomMusings/javascript/">Alea</a> by Johannes Baagoe</td>
			<td style="text-align:center">By <a href="http://www.iro.umontreal.ca/~lecuyer/">Pierre L'Ecuyer</a>, implementation by <a href="http://baagoe.com/en/RandomMusings/javascript/">Johannes Baagoe</a></td>
		</tr>
		<tr class='even'>
			<td><b>.random()</b></td>
			<td><canvas class="static" id="default_canvas"></canvas></td>
			<td><canvas class="static" id="MersenneTwister_canvas"></canvas></td>
			<td><canvas class="static" id="MultiplyWithCarry_canvas"></canvas></td>
			<td><canvas class="static" id="CombinedMultipleRecursive_canvas"></canvas></td>
		</tr>
		<tr class='even'>
			<td></td>
			<td>
				Generated <span id="default_numbers">0</span> numbers in  <span id="default_ms">0</span>ms
				<br />
				Sample between 0 &amp; 1:<br /><span id="default_sample"></span>
			</td>
			<td>
				Generated <span id="MersenneTwister_numbers">0</span> numbers in  <span id="MersenneTwister_ms">0</span>ms
				<br />
				Sample between 0 &amp; 1:<br /><span id="MersenneTwister_sample"></span>
			</td>
			<td>
				Generated <span id="MultiplyWithCarry_numbers">0</span> numbers in  <span id="MultiplyWithCarry_ms">0</span>ms
				<br />
				Sample between 0 &amp; 1:<br /><span id="MultiplyWithCarry_sample"></span>
			</td>
			<td>
				Generated <span id="CombinedMultipleRecursive_numbers">0</span> numbers in  <span id="CombinedMultipleRecursive_ms">0</span>ms
				<br />
				Sample between 0 &amp; 1:<br /><span id="CombinedMultipleRecursive_sample"></span>
			</td>
		</tr>
		<tr class='odd'>
			<td><b>.randomInteger()</b></td>
			<td>
				Generated <span id="default_numbers_int">0</span> integers in  <span id="default_ms_int">0</span>ms
				<br />
				Sample between 0 &amp; 100:<br/><span id="default_sample_int"></span>
			</td>
			<td>
				Generated <span id="MersenneTwister_numbers_int">0</span> integers in  <span id="MersenneTwister_ms_int">0</span>ms
				<br />
				Sample between 0 &amp; 100:<br/><span id="MersenneTwister_sample_int"></span>
			</td>
			<td>
				Generated <span id="MultiplyWithCarry_numbers_int">0</span> integers in  <span id="MultiplyWithCarry_ms_int">0</span>ms
				<br />
				Sample between 0 &amp; 100:<br/><span id="MultiplyWithCarry_sample_int"></span>
			</td>
			<td>
				Generated <span id="CombinedMultipleRecursive_numbers_int">0</span> integers in  <span id="CombinedMultipleRecursive_ms_int">0</span>ms
				<br />
				Sample between 0 &amp; 100:<br/><span id="CombinedMultipleRecursive_sample_int"></span>
			</td>
		</tr>
		<tr class='even'>
			<td><b>.random()</b><br/>&nbsp;&nbsp;&nbsp;seed = 1234554321</td>
			<td>No Seed</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MersenneTwister_seed">getSeed BROKEN</span>)</td></tr>
					<tr><td> 
						0.7705488030333072<br />
						0.9157095490954816<br />
						0.8911646278575063<br />
						0.8985830768942833<br />
						0.4490348510444164
						</td>
						<td id="MersenneTwister_seeded"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MultiplyWithCarry_seed">getSeed BROKEN</span>)</td></tr>
					<tr><td> 
						0.8372999881394207<br />
						0.6222107214853168<br />
						0.2954180813394487<br />
						0.30998755944892764<br />
						0.21168458950705826
						</td>
						<td id="MultiplyWithCarry_seeded"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="CombinedMultipleRecursive_seed">getSeed BROKEN</span>)</td></tr>
					<tr><td> 
						0.03376369550824165<br />
						0.6424865152221173<br />
						0.5994708603248<br />
						0.23270360473543406<br />
						0.2999202616047114
						</td>
						<td id="CombinedMultipleRecursive_seeded"></td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class='odd'>
			<td><b>.randomInteger()</b><br/>&nbsp;&nbsp;&nbsp;seed = 1234554321</td>
			<td>No Seed</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MersenneTwister_seed_int">getSeed BROKEN</span>)</td></tr>
					<tr><td>77, 92, 90, 90, 45, 65, 42</td>
						<td id="MersenneTwister_seeded_int"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MultiplyWithCarry_seed_int">getSeed BROKEN</span>)</td></tr>
					<tr><td>84, 62, 29, 31, 21, 99, 6</td>
						<td id="MultiplyWithCarry_seeded_int"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="CombinedMultipleRecursive_seed_int">getSeed BROKEN</span>)</td></tr>
					<tr><td>3, 64, 60, 23, 30, 94, 99</td>
						<td id="CombinedMultipleRecursive_seeded_int"></td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class='even'>
			<td><b>.normal()</b></td>
			<td><canvas class="curve" id="default_canvas_normal"></canvas></td>
			<td><canvas class="curve" id="MersenneTwister_canvas_normal"></canvas></td>
			<td><canvas class="curve" id="MultiplyWithCarry_canvas_normal"></canvas></td>
			<td><canvas class="curve" id="CombinedMultipleRecursive_canvas_normal"></canvas></td>
		</tr>
		<tr class='even'>
			<td></td>
			<td>
				Generated <span id="default_numbers_normal">0</span> numbers in  <span id="default_ms_normal">0</span>ms
			</td>
			<td>
				Generated <span id="MersenneTwister_numbers_normal">0</span> numbers in  <span id="MersenneTwister_ms_normal">0</span>ms
			</td>
			<td>
				Generated <span id="MultiplyWithCarry_numbers_normal">0</span> numbers in  <span id="MultiplyWithCarry_ms_normal">0</span>ms
			</td>
			<td>
				Generated <span id="CombinedMultipleRecursive_numbers_normal">0</span> numbers in  <span id="CombinedMultipleRecursive_ms_normal">0</span>ms
			</td>
		</tr>
		<tr class='odd'>
			<td><b>.normalInteger()</b></td>
			<td>
				Generated <span id="default_numbers_normal_int">0</span> integers in  <span id="default_ms_normal_int">0</span>ms
				<br />
				Sample mean = 10, stddev = 5:<br/><span id="default_sample_normal_int_1"></span><br />
				Sample mean = 8, stddev = 1:<br/><span id="default_sample_normal_int_2"></span>
			</td>
			<td>
				Generated <span id="MersenneTwister_numbers_normal_int">0</span> integers in  <span id="MersenneTwister_ms_normal_int">0</span>ms
				<br />
				Sample mean = 10, stddev = 5:<br/><span id="MersenneTwister_sample_normal_int_1"></span><br />
				Sample mean = 8, stddev = 1:<br/><span id="MersenneTwister_sample_normal_int_2"></span>
			</td>
			<td>
				Generated <span id="MultiplyWithCarry_numbers_normal_int">0</span> integers in  <span id="MultiplyWithCarry_ms_normal_int">0</span>ms
				<br />
				Sample mean = 10, stddev = 5:<br/><span id="MultiplyWithCarry_sample_normal_int_1"></span><br />
				Sample mean = 8, stddev = 1:<br/><span id="MultiplyWithCarry_sample_normal_int_2"></span>
			</td>
			<td>
				Generated <span id="CombinedMultipleRecursive_numbers_normal_int">0</span> integers in  <span id="CombinedMultipleRecursive_ms_normal_int">0</span>ms
				<br />
				Sample mean = 10, stddev = 5:<br/><span id="CombinedMultipleRecursive_sample_normal_int_1"></span><br />
				Sample mean = 8, stddev = 1:<br/><span id="CombinedMultipleRecursive_sample_normal_int_2"></span>
			</td>
		</tr>
		<tr class='even'>
			<td><b>.normal()</b><br/>&nbsp;&nbsp;&nbsp;seed = 1234554321</td>
			<td>No Seed</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MersenneTwister_seed_normal">getSeed BROKEN</span>)</td></tr>
					<tr><td> 
						9.48415023763143<br />
						10.881197009665062<br />
						9.596079040760005<br />
						10.545666805783755<br />
						8.571924360655567
						</td>
						<td id="MersenneTwister_seeded_normal"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MultiplyWithCarry_seed_normal">getSeed BROKEN</span>)</td></tr>
					<tr><td> 
						9.414594136043046<br />
						9.393706811688528<br />
						12.05347123981709<br />
						9.187158889107625<br />
						9.696011429882018
						</td>
						<td id="MultiplyWithCarry_seeded_normal"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="CombinedMultipleRecursive_seed_normal">getSeed BROKEN</span>)</td></tr>
					<tr><td> 
						7.127036852631531<br />
						7.697922816581407<br />
						11.422235007704273<br />
						10.155174843861676<br />
						9.159917388676593
						</td>
						<td id="CombinedMultipleRecursive_seeded_normal"></td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class='odd'>
			<td><b>.normalInteger()</b><br/>&nbsp;&nbsp;&nbsp;seed = 1234554321</td>
			<td>No Seed</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MersenneTwister_seed_normal_int">getSeed BROKEN</span>)</td></tr>
					<tr><td>9, 9, 11, 10, 11, 9, 9</td>
						<td id="MersenneTwister_seeded_normal_int"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="MultiplyWithCarry_seed_normal_int">getSeed BROKEN</span>)</td></tr>
					<tr><td>12, 9, 9, 12, 9, 10, 12</td>
						<td id="MultiplyWithCarry_seeded_normal_int"></td>
					</tr>
				</table>
			</td>
			<td>
				<table>
					<tr><td>Expected</td><td>Actual (<span id="CombinedMultipleRecursive_seed_normal_int">getSeed BROKEN</span>)</td></tr>
					<tr><td>12, 7, 8, 11, 10, 9, 12</td>
						<td id="CombinedMultipleRecursive_seeded_normal_int"></td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
</body>
<script type='text/javascript' src='../lib/Randomizer.js'></script>
<script type='text/javascript' src='../lib/rng/MersenneTwister.js'></script>
<script type='text/javascript' src='../lib/rng/MultiplyWithCarry.js'></script>
<script type='text/javascript' src='../lib/rng/CombinedMultipleRecursive.js'></script>
<script type='text/javascript'>

	test_method('default');
	test_method('MersenneTwister');
	test_method('MultiplyWithCarry');
	test_method('CombinedMultipleRecursive');


	function test_method(rng_name) {
		if(rng_name != 'default' && typeof window[rng_name] === 'undefined') {
			return;
		}	

		var options = { RNG: rng_name};
		if(rng_name === 'default') {
			options = {};
		}
		var r = new Randomizer(options);

		gen_bitmap(rng_name, r);

		var start = (new Date).getTime();
		gen_normal_curve(rng_name, r);
		var plot_end = (new Date).getTime() - start;

		// check random
		var numbers = 1000000; // 1,000,000
		var ms = run_time(r.random, numbers);
		document.getElementById(rng_name + "_numbers").innerHTML = "1 million";
		document.getElementById(rng_name + "_ms").innerHTML = ms;

		// check randomInteger
		var numbers = 1000000; // 1,000,000
		var ms = run_time(r.randomInteger, numbers);
		document.getElementById(rng_name + "_numbers_int").innerHTML = "1 million";
		document.getElementById(rng_name + "_ms_int").innerHTML = ms;

		// get some samples
		var floats = sample(r.random,5);
		document.getElementById(rng_name + "_sample").innerHTML = floats.join("<br />");
		var ints = sample(r.randomInteger,10);
		document.getElementById(rng_name + "_sample_int").innerHTML = ints.join(", ");

		// check seeds
		if(rng_name !== 'default') {
			r.setSeed(1234554321)
			var floats = sample(r.random,5);
			document.getElementById(rng_name + "_seeded").innerHTML = floats.join("<br />");

			r.setSeed(1234554321)
			var ints = sample(r.randomInteger,7);
			document.getElementById(rng_name + "_seeded_int").innerHTML = ints.join(", ");

			check_getseed(rng_name, r);
		}

		// test normal values

		// check normal
		document.getElementById(rng_name + "_numbers_normal").innerHTML = "1 million";
		document.getElementById(rng_name + "_ms_normal").innerHTML = plot_end;

		// check normalInteger
		var numbers = 1000000; // 1,000,000
		var ms = run_time(function() { return r.normalInteger(3,1); }, numbers);
		document.getElementById(rng_name + "_numbers_normal_int").innerHTML = "1 million";
		document.getElementById(rng_name + "_ms_normal_int").innerHTML = ms;

		// get some samples
		ints = sample(function() { return r.normalInteger(10,5); },5);
		document.getElementById(rng_name + "_sample_normal_int_1").innerHTML = ints.join(", ");
		ints = sample(function() { return r.normalInteger(8,1); },5);
		document.getElementById(rng_name + "_sample_normal_int_2").innerHTML = ints.join(", ");

		// check seeds
		if(rng_name !== 'default') {
			r.setSeed(1234554321)
			var floats = sample(function() { return r.normal(10,2); },5);
			document.getElementById(rng_name + "_seeded_normal").innerHTML = floats.join("<br />");
			r.setSeed(1234554321)
			var ints = sample(function() { return r.normalInteger(10,2); },7);
			document.getElementById(rng_name + "_seeded_normal_int").innerHTML = ints.join(", ");
		}
	}

	function sample(random_func, count) {
		var rand = random_func(0,100); // args are ignored if irrelevant
		if(count == 1) {
			return [rand];
		}
		return [rand].concat(sample(random_func, count-1));
	}

	function run_time(random_func, count) {
		var start = (new Date).getTime();

		while(count--) {
			random_func();
		}

		return (new Date).getTime() - start;
	}

	function check_getseed(rng_name, r) {
		document.getElementById(rng_name + "_seed").innerHTML = r.getSeed();
		document.getElementById(rng_name + "_seed_int").innerHTML = r.getSeed();
		document.getElementById(rng_name + "_seed_normal").innerHTML = r.getSeed();
		document.getElementById(rng_name + "_seed_normal_int").innerHTML = r.getSeed();
	}

	// generate bitmaps for each of the randomizers
	function gen_bitmap(rng, r) {
		var SCREEN_HEIGHT = 150, SCREEN_WIDTH = 200; // different from the canvas - annoying

		var canvas = document.getElementById(rng + '_canvas');
		var context = canvas.getContext('2d');
		context.mozImageSmoothingEnabled=false;
		var image = context.getImageData(0,0,SCREEN_WIDTH, SCREEN_HEIGHT);

		var pixels = SCREEN_WIDTH*SCREEN_HEIGHT;

		var img_data = image.data;
		while(pixels >= 0){
			if(r.random() > .5) {
			   img_data[4*pixels+0] = 0; // Red value
			   img_data[4*pixels+1] = 0; // Green value
			   img_data[4*pixels+2] = 0; // Blue value
			   img_data[4*pixels+3] = 255; // Alpha value
			} else {
			   img_data[4*pixels+0] = 255; // Red value
			   img_data[4*pixels+1] = 255; // Green value
			   img_data[4*pixels+2] = 255; // Blue value
			   img_data[4*pixels+3] = 255; // Alpha value
			}
			
		   pixels--;
		}
		image.data = img_data;
		context.putImageData(image, 0, 0);
	}

	function gen_normal_curve(rng, r) {
		var SCREEN_HEIGHT = 150, SCREEN_WIDTH = 200; // different from the canvas - annoying

		var TOTAL_POINTS = 1000000; // 1,000,000
		var PSEUDO_X = 100;
		var PSEUDO_Y = 1;
		var generated_points = {};
		for(i = 0; i < TOTAL_POINTS; i++) {
			var pt = r.normalInteger(50, 10);
			if(generated_points[pt] === undefined) {
				generated_points[pt] = 0;
			}
			generated_points[pt]++;
		}

		var canvas = document.getElementById(rng + '_canvas_normal');
		var context = canvas.getContext('2d');
		context.mozImageSmoothingEnabled=false;
		var image = context.getImageData(0,0,SCREEN_WIDTH, SCREEN_HEIGHT);

		//console.log(generated_points);

		var img_data = image.data;
		var x_scale = SCREEN_WIDTH / PSEUDO_X;
		for(x = 0; x < SCREEN_WIDTH; x++) {
			var mapped_x = Math.floor(x / x_scale);
			for(y=0; y < SCREEN_HEIGHT; y++) {
				var pixel = x+y*SCREEN_WIDTH;
				if(generated_points[mapped_x] !== undefined) {
					var prob = generated_points[mapped_x] / (TOTAL_POINTS / 17);
					var mapped_y = Math.floor(SCREEN_HEIGHT * prob);
					var reverse_y = SCREEN_HEIGHT - y - 1;
					if(reverse_y == mapped_y) {
						img_data[4*pixel+0] = 0; // R
						img_data[4*pixel+1] = 0; // G
						img_data[4*pixel+2] = 0; // B
						img_data[4*pixel+3] = 255; // Alpha
						continue;
					}
				}
				img_data[4*pixel+0] = 255; // R
				img_data[4*pixel+1] = 255; // G
				img_data[4*pixel+2] = 255; // B
				img_data[4*pixel+3] = 255; // Alpha
			}
		}
		image.data = img_data;
		context.putImageData(image, 0, 0);
	}
</script>
</html>
